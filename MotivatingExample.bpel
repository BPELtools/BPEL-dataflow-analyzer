<?xml version="1.0" encoding="UTF-8"?>
<!--
Copyright 2008 Sebastian Breier

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<bpws:process exitOnStandardFault="yes" name="MotivatingExample"
    suppressJoinFailure="yes"
    targetNamespace="http://eclipse.org/bpel/sample"
    xmlns:bpws="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:tns="http://eclipse.org/bpel/sample">
    <bpws:import importType="http://schemas.xmlsoap.org/wsdl/"
        location="MotivatingExample.wsdl" namespace="http://eclipse.org/bpel/sample"/>
    <bpws:partnerLinks>
        <bpws:partnerLink myRole="MotivatingExampleProvider"
            name="customer" partnerLinkType="tns:MotivatingExample" partnerRole="MotivatingExampleProvider"/>
        <bpws:partnerLink myRole="MotivatingExampleProvider"
            name="orderProcessor"
            partnerLinkType="tns:MotivatingExample" partnerRole="MotivatingExampleProvider"/>
        <bpws:partnerLink myRole="MotivatingExampleProvider"
            name="pymtProcessor" partnerLinkType="tns:MotivatingExample" partnerRole="MotivatingExampleProvider"/>
    </bpws:partnerLinks>
    <bpws:variables>
        <bpws:variable messageType="tns:orderInfoMessage" name="orderInfo"/>
        <bpws:variable messageType="tns:pymtInfoMessage" name="pymtInfo"/>
        <bpws:variable messageType="tns:responseMessage" name="response"/>
    </bpws:variables>
    <bpws:flow name="Flow">
        <bpws:links>
            <bpws:link name="link1"/>
            <bpws:link name="link2"/>
            <bpws:link name="link3"/>
            <bpws:link name="link5"/>
            <bpws:link name="link6"/>
            <bpws:link name="link7"/>
            <bpws:link name="link8"/>
            <bpws:link name="link9"/>
            <bpws:link name="link10"/>
        </bpws:links>
        <bpws:receive createInstance="yes" name="A" operation="order"
            partnerLink="customer" portType="tns:MotivatingExample" variable="orderInfo">
            <bpws:sources>
                <bpws:source linkName="link1"/>
            </bpws:sources>
        </bpws:receive>
        <bpws:assign name="B" validate="no">
            <bpws:targets>
                <bpws:target linkName="link1"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="link2">
                    <bpws:transitionCondition>$orderInfo.status = silver</bpws:transitionCondition>
                </bpws:source>
                <bpws:source linkName="link3">
                    <bpws:transitionCondition>$orderInfo.status = gold</bpws:transitionCondition>
                </bpws:source>
                <bpws:source linkName="link6"/>
            </bpws:sources>
            <bpws:copy>
                <bpws:from part="itemPrice" variable="orderInfo"/>
                <bpws:to part="amt" variable="pymtInfo"/>
            </bpws:copy>
            <bpws:copy>
                <bpws:from part="accountNumber" variable="orderInfo"/>
                <bpws:to part="actNum" variable="pymtInfo"/>
            </bpws:copy>
            <bpws:copy>
                <bpws:from>
                    <bpws:literal>Dear customer, ...</bpws:literal>
                </bpws:from>
                <bpws:to part="text" variable="response"/>
            </bpws:copy>
        </bpws:assign>
        <bpws:assign name="C" validate="no">
            <bpws:targets>
                <bpws:target linkName="link2"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="link7"/>
            </bpws:sources>
            <bpws:copy>
                <bpws:from>
                    <bpws:literal>Five percent discount</bpws:literal>
                </bpws:from>
                <bpws:to part="text" variable="response"/>
            </bpws:copy>
            <bpws:copy>
                <bpws:from>$pymtInfo.amt</bpws:from>
                <bpws:to part="amt" variable="pymtInfo"/>
            </bpws:copy>
        </bpws:assign>
        <bpws:scope name="Scope">
            <bpws:targets>
                <bpws:target linkName="link3"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="link5"/>
            </bpws:sources>
            <bpws:variables>
                <bpws:variable messageType="tns:discountMessage" name="discount"/>
            </bpws:variables>
            <bpws:partnerLinks>
                <bpws:partnerLink myRole="MotivatingExampleProvider"
                    name="discountLink"
                    partnerLinkType="tns:MotivatingExample" partnerRole="MotivatingExampleProvider"/>
            </bpws:partnerLinks>
            <bpws:faultHandlers>
                <bpws:catch>
                    <bpws:assign name="F" validate="no">
                        <bpws:copy>
                            <bpws:from>
                                <bpws:literal>Ten percent discount</bpws:literal>
                            </bpws:from>
                            <bpws:to part="text" variable="response"/>
                        </bpws:copy>
                        <bpws:copy>
                            <bpws:from>$pymtInfo.amt</bpws:from>
                            <bpws:to part="amt" variable="pymtInfo"/>
                        </bpws:copy>
                    </bpws:assign>
                </bpws:catch>
            </bpws:faultHandlers>
            <bpws:flow>
                <bpws:links>
                    <bpws:link name="link4"/>
                </bpws:links>
                <bpws:invoke inputVariable="orderInfo" name="D"
                    operation="dynamicDiscount"
                    outputVariable="discount" partnerLink="discountLink" portType="tns:MotivatingExample">
                    <bpws:sources>
                        <bpws:source linkName="link4"/>
                    </bpws:sources>
                </bpws:invoke>
                <bpws:assign name="E" validate="no">
                    <bpws:targets>
                        <bpws:target linkName="link4"/>
                    </bpws:targets>
                    <bpws:copy>
                        <bpws:from><bpws:literal>discount</bpws:literal></bpws:from>
                        <bpws:to part="text" variable="response"/>
                    </bpws:copy>
                    <bpws:copy>
                        <bpws:from>$pymtInfo.amt</bpws:from>
                        <bpws:to part="amt" variable="pymtInfo"/>
                    </bpws:copy>
                </bpws:assign>
            </bpws:flow>
        </bpws:scope>
        <bpws:reply name="J" operation="order" partnerLink="customer"
            portType="tns:MotivatingExample" variable="response">
            <bpws:targets>
                <bpws:target linkName="link10"/>
            </bpws:targets>
        </bpws:reply>
        <bpws:assign name="G" validate="no">
            <bpws:targets>
                <bpws:target linkName="link5"/>
                <bpws:target linkName="link6"/>
                <bpws:target linkName="link7"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="link8"/>
            </bpws:sources>
            <bpws:copy>
                <bpws:from>
                    <bpws:literal>price calculated</bpws:literal>
                </bpws:from>
                <bpws:to part="orderStatus" variable="orderInfo"/>
            </bpws:copy>
        </bpws:assign>
        <bpws:invoke inputVariable="orderInfo" name="H"
            operation="processOrder" partnerLink="orderProcessor" portType="tns:MotivatingExample">
            <bpws:targets>
                <bpws:target linkName="link8"/>
            </bpws:targets>
            <bpws:sources>
                <bpws:source linkName="link9"/>
                <bpws:source linkName="link10"/>
            </bpws:sources>
        </bpws:invoke>
        <bpws:invoke inputVariable="pymtInfo" name="I"
            operation="processPayment" partnerLink="pymtProcessor" portType="tns:MotivatingExample">
            <bpws:targets>
                <bpws:target linkName="link9"/>
            </bpws:targets>
        </bpws:invoke>
    </bpws:flow>
</bpws:process>
